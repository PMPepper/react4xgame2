!function(){"use strict";var e={8024:function(e,t,i){var n=i(5671),s=i(3144),a=i(1413),r=i(763);function o(e,t){for(var i={},n=0,s=Object.keys(e),a=s.length;n<a;++n){var r=s[n],o=e[r];i[r]=t(o,r,e)}return i}function c(e,t){for(var i=0,n=Object.keys(e),s=n.length;i<s;++i){var a=n[i];t(e[a],a,e)}return e}var l=i(9062);function u(e,t,i){if(isNaN(e)||e<0||isNaN(t)||t<0||isNaN(i)||i<0)throw new Error("Invalid orbitPeriod values");var n=e*e*e,s=667408e-16*(t+i);return 2*Math.PI*Math.sqrt(n/s)}var h={equations:{},baseSpecies:{growthRate:1.05,production:1,research:1,mining:1,support:.2,workerMultiplier:1,crewMultiplier:1},minerals:{1:"Thatcherite",2:"Blairite",3:"Brownite",4:"Corbynite",5:"Adamantium",6:"Mayite",7:"Chobium",8:"Sloughium",9:"Muskite",10:"Majorium",11:"Cameronium",12:"Stellarium"},startingWorldMinerals:{1:{quantity:[4e5,5e5],access:[.7,1]},2:{quantity:[5e4,1e5],access:[.5,1]},3:{quantity:[5e4,1e5],access:[.5,1]},4:{quantity:[5e4,1e5],access:[.5,1]},5:{quantity:[5e4,1e5],access:[.8,1]},6:{quantity:[5e4,1e5],access:[.5,1]},7:{quantity:[5e4,1e5],access:[.5,1]},8:{quantity:[5e4,1e5],access:[.5,1]},9:{quantity:[5e4,1e5],access:[.5,1]},10:{quantity:[5e4,1e5],access:[.5,1]},11:{quantity:[5e4,1e5],access:[.5,1]},12:{quantity:[2e5,25e4],access:[.5,1]}},systemBodyTypeMineralAbundance:{planet:{1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1},moon:{1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1},dwarfPlanet:{1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1},asteroid:{1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:.2},gasGiant:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:1}},structures:{1:{name:"Conventional industry",mass:25e6,workers:5e4,bp:100,minerals:{},capabilities:{construction:1},upgrade:[3],requireTechnologyIds:[]},2:{name:"Conventional mine",mass:25e6,workers:5e4,bp:100,minerals:{},capabilities:{mining:1},upgrade:[4],requireTechnologyIds:[]},3:{name:"PE Industry",mass:25e6,workers:5e4,bp:120,minerals:{4:60,3:30,2:30},capabilities:{construction:10},requireTechnologyIds:["pe"]},4:{name:"PE mine",mass:25e6,workers:5e4,bp:120,minerals:{4:60,1:30},capabilities:{mining:10},requireTechnologyIds:["pe"]},5:{name:"Conventional research facility",mass:5e8,workers:1e6,bp:2e3,minerals:{},capabilities:{research:10},upgrade:[6],requireTechnologyIds:[]},6:{name:"PE research facility",mass:5e8,workers:1e6,bp:2400,minerals:{4:1200,9:1200},capabilities:{research:100},requireTechnologyIds:["pe"]}},researchAreas:{1:"Biology",2:"Industrial",3:"Defensive systems",4:"Energy weapons",5:"Logistics",6:"Ground combat",7:"Missiles and kinetic weapons",8:"Power and propulsion",9:"Sensors and fire control"},research:{m1:{name:"Mining rate 1",description:"Increase mining production by 20%",cost:100,area:2,requireResearchIds:[],unlockTechnologyIds:["m1"]},m2:{name:"Mining rate 2",description:"Increase mining production by 20%",cost:100,area:2,requireResearchIds:["m1"],unlockTechnologyIds:["m2"]},m3:{name:"Mining rate 3",description:"Increase mining production by 20%",cost:100,area:2,requireResearchIds:["m2"],unlockTechnologyIds:["m3"]},m4:{name:"Mining rate 4",description:"Increase mining production by 20%",cost:100,area:2,requireResearchIds:["m3"],unlockTechnologyIds:["m4"]},m5:{name:"Mining rate 5",description:"Increase mining production by 20%",cost:100,area:2,requireResearchIds:["m4"],unlockTechnologyIds:["m5"]},c1:{name:"Construction rate 1",description:"Increase construction rate by 20%",cost:100,area:2,requireResearchIds:[],unlockTechnologyIds:["c1"]},c2:{name:"Construction rate 2",description:"Increase construction rate by 20%",cost:100,area:2,requireResearchIds:["c1"],unlockTechnologyIds:["c2"]},c3:{name:"Construction rate 3",description:"Increase construction rate by 20%",cost:100,area:2,requireResearchIds:["c2"],unlockTechnologyIds:["c3"]},c4:{name:"Construction rate 4",description:"Increase construction rate by 20%",cost:100,area:2,requireResearchIds:["c3"],unlockTechnologyIds:["c4"]},c5:{name:"Construction rate 5",description:"Increase construction rate by 20%",cost:100,area:2,requireResearchIds:["c4"],unlockTechnologyIds:["c5"]},r1:{name:"Research rate 1",description:"Increase research speed by 20%",cost:100,area:2,requireResearchIds:[],unlockTechnologyIds:["r1"]},r2:{name:"Research rate 2",description:"Increase research speed by 20%",cost:100,area:2,requireResearchIds:["r1"],unlockTechnologyIds:["r2"]},r3:{name:"Research rate 3",description:"Increase research speed by 20%",cost:100,area:2,requireResearchIds:["r2"],unlockTechnologyIds:["r3"]},r4:{name:"Research rate 4",description:"Increase research speed by 20%",cost:100,area:2,requireResearchIds:["r3"],unlockTechnologyIds:["r4"]},r5:{name:"Research rate 5",description:"Increase research speed by 20%",cost:100,area:2,requireResearchIds:["r4"],unlockTechnologyIds:["r5"]},pe:{name:"Post-Einstein technology",description:"Unlock the potential of Post-Einsteinium (PE) physics to create technology vastly superior to anything previously thought possible.",cost:5e3,area:2,requireResearchIds:[],unlockTechnologyIds:["pe"]},test1:{name:"Test 1",description:"A test technology.",cost:5e3,area:2,requireResearchIds:[],unlockTechnologyIds:[]},test2:{name:"Test 2",description:"Another test technology.",cost:5e3,area:2,requireResearchIds:[],unlockTechnologyIds:[]},e1:{name:"PE Drive",description:"Utilise PE physics to create a fundamentally new form of propulsion and gain access to the far reaches of our solar system",cost:500,area:8,requireResearchIds:["pe"],unlockTechnologyIds:["e1","fe1"]}},technology:{pe:{name:"Post-Einstein technology"},e1:{name:"PE Drive"},fe1:{name:"Fuel efficiency 1"},m1:{name:"Mining rate 1",modifyCapabilities:{mining:.2}},m2:{name:"Mining rate 2",modifyCapabilities:{mining:.2}},m3:{name:"Mining rate 3",modifyCapabilities:{mining:.2}},m4:{name:"Mining rate 4",modifyCapabilities:{mining:.2}},m5:{name:"Mining rate 5",modifyCapabilities:{mining:.2}},c1:{name:"Construction rate 1",modifyCapabilities:{construction:.2}},c2:{name:"Construction rate 2",modifyCapabilities:{construction:.2}},c3:{name:"Construction rate 3",modifyCapabilities:{construction:.2}},c4:{name:"Construction rate 4",modifyCapabilities:{construction:.2}},c5:{name:"Construction rate 5",modifyCapabilities:{construction:.2}},r1:{name:"Research rate 1",modifyCapabilities:{research:.2}},r2:{name:"Research rate 2",modifyCapabilities:{research:.2}},r3:{name:"Research rate 3",modifyCapabilities:{research:.2}},r4:{name:"Research rate 4",modifyCapabilities:{research:.2}},r5:{name:"Research rate 5",modifyCapabilities:{research:.2}}}};function d(e,t){if("star"===e.type)return null;return o(t.minerals,(function(i,n){var s=t.systemBodyTypeMineralAbundance[e.type][n],a=Math.floor(Math.random()*s*Math.pow(e.mass,.2)),r=Math.ceil(10*Math.random())/10;return 0===a||0===r?{quantity:0,access:0}:{quantity:a,access:r}}))}function p(e,t,i,n){return e?"regular"===e.type?(0,a.Z)((0,a.Z)({},e),{},{type:"orbitRegular",orbitingId:i,period:u(e.radius,t,n)}):"elliptical"===e.type?(0,a.Z)((0,a.Z)({},e),{},{type:"orbitElliptical",orbitingId:i}):void 0:null}function y(e,t){var i={};function n(e,s){if(e.movement){var a=e.id;if(a in i)return i[a];var r=!1;if("orbitRegular"===e.movement.type)return r=function(e,i){if(e.movement&&e.movement.orbitingId){var s=i[e.movement.orbitingId],a=e.movement,r=a.radius,o=a.period,c=(t+o*a.offset)%o/o*Math.PI*2,l=e.position,u=r*Math.cos(c),h=r*Math.sin(c);return s&&(s.movement&&n(s,i),u+=s.position.x,h+=s.position.y),(l.x!==u||l.y!==h)&&(l.x=u,l.y=h,l.lastUpdateTime=t,!0)}}(e,s),i[a]=r}}return n}function m(e,t){var i=t[e.colonyId];if(i&&"colony"===i.type){var n=t[e.speciesId];e.population.supportWorkers=e.population.quantity*n.species.support,e.population.effectiveWorkers=(e.population.quantity-e.population.supportWorkers)*n.species.workerMultiplier}else e.population.supportWorkers=0,e.population.effectiveWorkers=0}function f(e,t,i,n){var s=n[t.speciesId],a=e?1:Math.pow(s.species.growthRate,.0027378507871321013);t.population.quantity*=a,m(t,n)}function g(e,t,i,n,s,a,r){var o=e.colony.structures[t],l={structuresWithCapability:{},capabilityProductionTotals:{},unitCapabilityProduction:{}};if(o){var u=null,h=0,d=0;if(c(o,(function(e,t){var i=n[t];if(!i)throw new Error("Unknown structure: '".concat(t,"'"));d+=i.workers*e})),0!==t){var p=s[t];if(u=s[p.speciesId],p.colonyId!==e.id)throw new Error("population not in colony");h=function(e,t,i,n,s){return Math.min(1,Math.floor(i)/n)}(0,0,p.population.effectiveWorkers,d)}c(o,(function(e,t){var s=n[t];c(s.capabilities,(function(n,o){var c,d=(null===(c=u)||void 0===c?void 0:c.species[o])||1,p=i[o]||1;o in a||(a[o]=0,r[o]={});var y=n*p*(s.workers>0?h*d:1),m=y*e;a[o]+=m,r[o][t]=e,o in l.structuresWithCapability||(l.capabilityProductionTotals[o]=0,l.structuresWithCapability[o]={},l.unitCapabilityProduction[o]={}),l.capabilityProductionTotals[o]+=m,l.structuresWithCapability[o][t]=e,l.unitCapabilityProduction[o][t]=y}))}))}return l}function v(e,t,i){return Math.floor(e/86400)!==Math.floor(t/86400)||i?function(e,t,n,s){if("colony"===e.type){var a,r,o=0,l=0,u=0,h=function(e){var t={};return c(e,(function(e){e.modifyCapabilities&&c(e.modifyCapabilities,(function(e,i){i in t||(t[i]=1),t[i]+=e}))})),t}(t[e.factionId].faction.technology),d=t[e.systemBodyId],p=n[e.factionId][e.systemBodyId],y=[],m=s.structures,v={},I={};for(e.colony.populationCapabilityProductionTotals={},e.colony.populationStructuresWithCapability={},a=0,r=e.populationIds.length;a<r;++a){var b=t[e.populationIds[a]];f(i,b,0,t),o+=b.population.quantity,l+=b.population.effectiveWorkers,u+=b.population.supportWorkers;var k=g(e,b.id,h,m,t,v,I);e.colony.populationCapabilityProductionTotals[b.id]=k.capabilityProductionTotals,e.colony.populationStructuresWithCapability[b.id]=k.structuresWithCapability,e.colony.populationUnitCapabilityProduction[b.id]=k.unitCapabilityProduction}var w=g(e,0,h,m,t,v,I);if(e.colony.populationCapabilityProductionTotals[0]=w.capabilityProductionTotals,e.colony.populationStructuresWithCapability[0]=w.structuresWithCapability,e.colony.populationUnitCapabilityProduction[0]=w.unitCapabilityProduction,e.colony.totalPopulation=Math.floor(o),e.colony.totalEffectiveWorkers=Math.floor(l),e.colony.totalSupportWorkers=Math.floor(u),e.colony.capabilityProductionTotals=v,e.colony.structuresWithCapability=I,v.mining&&p.isSurveyed){var C=v.mining;c(s.minerals,(function(t,i){var n=d.availableMinerals[i],s=C*n.access*.0027378507871321013;s>n.quantity&&(s=n.quantity),e.colony.minerals[i]=e.colony.minerals[i]+s,d.availableMinerals[i].quantity-=s,y.push(d.id)}))}return y}return!1}:null}var I="initialising",b="connecting",k="running",w=("object"===typeof window&&window,function(){function e(t){var i=this;(0,n.Z)(this,e),this.connector=null,this.phase=I,this.gameTime=null,this.totalElapsedTime=null,this.targetTickRate=60,this.timeMultiplier=60,this.gameSecondsPerStep=1,this.isPaused=!1,this.entities=null,this.entityId=null,this.entityIds=null,this.entitiesLastUpdated=null,this.factionEntities=null,this.factionEntitiesLastUpdated=null,this.entityProcessorFactories=[y,v],this.clientLastUpdatedTime=null,this._onTick=function(e){if(i._updateGameTime(),!i.isPaused){var t=e*i.timeMultiplier;i.totalElapsedTime+=t,i._advanceTime(i.gameSecondsPerStep)}Object.values(i.clients).forEach((function(e){i.connector.sendMessageToClient(e.id,"updatingGame",i._getClientState(e.id))}))},this.connector=t}return(0,s.Z)(e,[{key:"message_createWorld",value:function(e,t){if(this.phase!==I)throw new Error('Can only create world while Server is in "initialising" phase');return this.totalElapsedTime=this.gameTime=Math.floor(new Date(e.startDate).valueOf()/1e3),this.factions={},this.clients={},this.entityId=1,this.entities={},this.entityIds=[],this.clientLastUpdatedTime={},this.entitiesLastUpdated={},this.factionEntities={},this.factionEntitiesLastUpdated={},function(e,t){t=(0,a.Z)((0,a.Z)({},h),t),e.minerals=(0,a.Z)({},t.minerals),e.structures=JSON.parse(JSON.stringify(t.structures)),e.researchAreas=(0,a.Z)({},t.researchAreas),e.research=JSON.parse(JSON.stringify(t.research)),e.technology=JSON.parse(JSON.stringify(t.technology)),e.systemBodyTypeMineralAbundance=JSON.parse(JSON.stringify(t.systemBodyTypeMineralAbundance));var i={},n={},s={},r={};Object.keys(t.systems).forEach((function(n){var a=t.systems[n],r=e._newEntity("system",{});i[n]=r,s[n]={};var o=s[n],c=a.bodies.map((function(i){var n=i.mass||1,s=i.parent&&o[i.parent]&&(o[i.parent].id||null),a=e._newEntity("systemBody",{systemId:r.id,mass:{value:n},movement:p(i.orbit,n,s,s?o[i.parent].mass.value:0),position:{x:0,y:0},systemBody:{type:i.type,radius:i.radius,day:i.day,axialTilt:i.axialTilt,tidalLock:!!i.tidalLock,albedo:i.albedo||0,luminosity:i.luminosity||0,children:[],position:null},render:{type:"systemBody"},availableMinerals:d(i,t)});if(s){var c=e.entities[s];c.systemBody.children.push(a.id),a.systemBody.position=[].concat((0,l.Z)(c.systemBody.position),[c.systemBody.children.length])}else a.systemBody.position=[];return o[i.name],o[i.name]=a,a}));r.systemBodyIds=c.map((function(e){return e.id}))})),Object.keys(t.species).forEach((function(i){var s=t.species[i],r=e._newEntity("species",{species:(0,a.Z)((0,a.Z)({},t.baseSpecies),s)});n[i]=r})),t.factions.forEach((function(c){var l=e.createFaction(c.name,c.startingResearch);r[c.name]=l,c.startingResearch.forEach((function(e){var i=t.research[e];l.faction.research[e]=!0,i.unlockTechnologyIds.forEach((function(e){if(!t.technology[e])throw new Error("Unknown technology '".concat(e,"'"));l.faction.technology[e]=!0}))}));var u={};Object.keys(c.startingSystems).forEach((function(n){var a=t.systems[n],r=c.startingSystems[n],o=i[n],h=s[n];if(!o)throw new Error("Unknown system '".concat(n,"' in startingSystems for faction '").concat(c.name,"'"));if("known"!==r.type)throw new Error("Unknown value for factionStartingSystemDefinition.type");e._addFactionEntity(l.id,o.id,{name:r.name||n}),a.bodies.forEach((function(t){var i,n=e._addFactionEntity(l.id,h[t.name].id,{name:(null===(i=r.bodyNamesMap)||void 0===i?void 0:i[t.name])||t.name,isSurveyed:!1});u[n.id]=n}))})),c.startingColonies.forEach((function(i){var r=s[i.system][i.body],c=e.createColony(r.id,l.id,o(t.minerals,(function(){return 0})));i.populations.forEach((function(t){var i=0;if(t.species){var s=n[t.species];i=e.createPopulation(l.id,c.id,s.id,t.population).id}t.structures&&e.addStructuresToColony(c.id,i,(0,a.Z)({},t.structures))})),i.isSurveyed&&(u[r.id].isSurveyed=!0)}))}))}(this,e),this.gameConfig={minerals:this.minerals,structures:this.structures,researchAreas:this.researchAreas,research:this.research,technology:this.technology},this._advanceTime(null),this.phase=b,this.connector.broadcastToClients("phaseChanged",this.phase),Promise.resolve()}},{key:"message_connectClient",value:function(e,t){var i=e.name;if(this.phase!==b)throw new Error('Can only connect player while Server is in "connecting" phase');if(this.clients[t])throw new Error("Each client can only connect once");return this._checkValidClientName(i,t),this.clients[t]={name:i,id:t,type:"human",ready:!1,factions:{},factionId:null,gameTime:this.gameTime,gameSpeed:1,isPaused:!0},this.connector.broadcastToClients("clientConnected",this.clients),Promise.resolve({factions:this.factions,clients:this.clients,minerals:this.minerals,structures:this.structures,research:this.research,researchAreas:this.researchAreas,technology:this.technology})}},{key:"message_setClientSettings",value:function(e,t){var i=this,n=e.name,s=e.factions,r=e.factionId,c=e.ready;if(this.phase!==b)throw new Error('Can only set connected player settings while Server is in "connecting" phase');this._checkValidClient(t),this._checkValidClientName(n,t);var l=this.clients[t];if(null===s||function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(s))s=o(this.factions,(function(e){return 2}));else{if(Object.keys(s).some((function(e){return i._getClientsForFaction(e,[1]).some((function(e){return e!==t}))})))throw new Error("Invalid client settings, faction(s) already owned by '".concat(r,"'"));if(!this.factions[r])throw new Error("Invalid client settings, unknown factionId '".concat(r,"'"));if(!s[r])throw new Error("Invalid client settings, invalid factionId '".concat(r,"' (must be a faction you have permission for)"))}return c=!!c,this.clients[t]=(0,a.Z)((0,a.Z)({},l),{},{name:n,factions:s,factionId:r,ready:c}),this.connector.broadcastToClients("clientUpdated",this.clients),Promise.resolve(!0)}},{key:"message_startGame",value:function(e,t){var i=this;if(this.phase!==b)throw new Error('Can only start game while Server is in "connecting" phase');if(this._checkValidClient(t),this.phase=k,Object.values(this.clients).every((function(e){return e.ready}))){Object.values(this.clients).forEach((function(e){i.connector.sendMessageToClient(e.id,"startingGame",i._getClientState(e.id,!0))})),this._lastTime=Date.now();var n=1e3/this.targetTickRate,s=n/1e3;return this._tickId=setTimeout((function e(){if(i.phase!==k)i._tickId=null;else{var t=Date.now();i._onTick(s);var a=Date.now();i._tickId=setTimeout(e,Math.max(0,i._lastTime+n-a)),i._lastTime=t}}),n),Promise.resolve(!0)}return Promise.resolve(!1)}},{key:"message_getClientState",value:function(e,t){if(this.phase!==k)throw new Error('Can only get client state while server is in "running" phase');return this._checkValidClient(t),Promise.resolve(this._getClientState(t,!0))}},{key:"message_setDesiredSpeed",value:function(e,t){if(this.phase!==k)throw new Error('Can only set desired speed while server is in "running" phase');this._checkValidClient(t),this.clients[t].gameSpeed=Math.max(1,Math.min(5,0|e))}},{key:"message_setIsPaused",value:function(e,t){if(this.phase!==k)throw new Error('Can only set is paused while server is in "running" phase');this._checkValidClient(t),this.clients[t].isPaused=!!e}},{key:"message_createColony",value:function(e,t){if(this.phase!==k)throw new Error('Can only create colony while server is in "running" phase');this._checkValidClient(t);var i=this.createColony(e,this.clients[t].factionId);return Promise.resolve(i.id)}},{key:"message_createResearchGroup",value:function(e,t,i,n){if(this.phase!==k)throw new Error('Can only add research group while server is in "running" phase');this._checkValidClient(n);var s=this.clients[n].factionId,a=this.getEntityById(e);if(!a||a.factionId!==s)throw new Error("Cannot add researchGroup, invalid colony");var r=this.createResearchGroup(e,t||{},i||[]);return Promise.resolve(r.id)}},{key:"message_removeResearchGroup",value:function(e,t){if(this.phase!==k)throw new Error('Can only remove research group while server is in "running" phase');this._checkValidClient(t)}},{key:"message_updateResearchGroup",value:function(e,t,i,n){if(this.phase!==k)throw new Error('Can only remove research group while server is in "running" phase');this._checkValidClient(n)}},{key:"_checkValidClientName",value:function(e,t){if(!e)throw new Error("Client required a name");Object.values(this.clients).forEach((function(i){if(i.id!==t&&i.name===e)throw new Error("Client name already in use by another client")}))}},{key:"_checkValidClient",value:function(e){if(!this.clients[e])throw new Error("Unknown client")}},{key:"onMessage",value:function(e,t,i){var n="message_".concat(e);if(this[n])return this[n](t,i);console.log("Unknown message from client: ",e,t,i)}},{key:"getEntityById",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this.entities[e]||null;return i&&t&&i.type!==t?null:i}},{key:"getEntitiesByIds",value:function(e){var t=this.entities;return e.map((function(e){return t[e]}))}},{key:"createFaction",value:function(e){var t=this._newEntity("faction",{faction:{name:e,colonyIds:[],research:{},technology:{}}});return this.factionEntities[t.id]={},this.factionEntitiesLastUpdated[t.id]={},this.factions[t.id]=t,t}},{key:"createColony",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],a=this.entities[e],r=this.entities[t],o=this._newEntity("colony",{factionId:t,systemId:a.systemId,systemBodyId:a.id,researchGroupIds:[],populationIds:s,colony:{structures:n,minerals:i,researchInProgress:{},buildQueue:[],capabilityProductionTotals:{},structuresWithCapability:{},populationCapabilityProductionTotals:{},populationStructuresWithCapability:{},populationUnitCapabilityProduction:{}}});return r.faction.colonyIds.push(o.id),this.entitiesLastUpdated[t]=this.gameTime,o}},{key:"createResearchGroup",value:function(e,t,i){var n=this.getEntityById(e,"colony");if(!n)throw new Error("cannot create research group, invalid colonyId");return this._newEntity("researchGroup",{factionId:n.factionId,colonyId:n.id,researchGroup:{structures:t,projects:i}})}},{key:"createPopulation",value:function(e,t,i,n){var s=this.getEntityById(t,"colony"),a=this._newEntity("population",{factionId:e,speciesId:i,colonyId:s?s.id:null,population:{quantity:n,supportWorkers:0,effectiveWorkers:0}});return m(a,this.entities),a}},{key:"addPopulationToColony",value:function(e,t){var i=this.getEntityById(e,"colony"),n=this.getEntityById(t,"population");i&&n&&(i.populationIds.push(n.id),n.colonyId=i.id,i.colony.lastUpdateTime=this.gameTime,this.entitiesLastUpdated[e]=this.gameTime,this.entitiesLastUpdated[t]=this.gameTime)}},{key:"addStructuresToColony",value:function(e,t,i){var n=this.getEntityById(e,"colony");if(n){t=t||0,n.colony.structures[t]||(n.colony.structures[t]={}),n.colony.lastUpdateTime=this.gameTime;var s=n.colony.structures[t];c(i,(function(e,t){s[t]?s[t]+=e:s[t]=e,s[t]=Math.max(0,s[t])})),this.entitiesLastUpdated[e]=this.gameTime}}},{key:"_updateGameTime",value:function(){var e=5,t=!1;switch(Object.values(this.clients).forEach((function(i){e=Math.min(e,i.gameSpeed),t=t||i.isPaused})),e){case 1:this.timeMultiplier=1,this.gameSecondsPerStep=1;break;case 2:this.timeMultiplier=60,this.gameSecondsPerStep=1;break;case 3:this.timeMultiplier=3600,this.gameSecondsPerStep=1;break;case 4:this.timeMultiplier=86400,this.gameSecondsPerStep=60;break;case 5:this.timeMultiplier=604800,this.gameSecondsPerStep=360;break;default:throw new Error("Unknown speed value")}this.gameSpeed=e,this.isPaused=t}},{key:"_advanceTime",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=this.entities,n=this.entityIds,s=this.entitiesLastUpdated,a=n.length,r=null;if(null!==t)for(var o=Math.floor(this.totalElapsedTime),c=function(){var r=e.gameTime;e.gameTime=Math.min(e.gameTime+t,o);for(var c=e.gameTime,l=e._getEntityProcessors(r,c),u=void 0,h=0;h<a;++h){var d=n[h];(u=l(i[d],i,e.factionEntities))&&(s[d]=c,u instanceof Array&&u.forEach((function(e){s[e]=c})))}};this.gameTime<o;)c();else{r=this._getEntityProcessors(this.gameTime,this.gameTime,!0);for(var l=0;l<a;++l)r(i[n[l]],i,this.factionEntities)}}},{key:"_getEntityProcessors",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=this.entityProcessorFactories.map((function(i){return i(e,t,n)})).filter((function(e){return!!e}));return function(e,t,n){for(var a=!1,r=0,o=s.length;r<o;++r)a=s[r](e,t,n,i.gameConfig)||a;return a}}},{key:"_getClientState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.gameTime,n=this.entities,s=this.entitiesLastUpdated,a=this.clients[e],r=a.factionId,o=this.factionEntities[r],c=this.factionEntitiesLastUpdated[r],l=this.entityIds,u=this.clientLastUpdatedTime[e];t=t||!u;for(var h={},d={},p=0,y=l.length;p<y;++p){var m=l[p],f=n[m];if((t||s[m]>u)&&(!f.factionId||f.factionId===r))if(t)h[m]=f;else{var g=C(f,u);g&&(h[m]=g)}o[m]&&(t||c[m]>u)&&(d[m]=o[m])}return this.clientLastUpdatedTime[e]=i,{entities:h,factionEntities:d,gameTime:i,gameSpeed:this.gameSpeed,desiredGameSpeed:a.gameSpeed,isPaused:this.isPaused,factionId:a.factionId}}},{key:"_newEntity",value:function(e,t){var i=(0,a.Z)((0,a.Z)({},t),{},{id:this.entityId++,type:e});this.entities[i.id]=i,this.entityIds.push(i.id),this.entitiesLastUpdated[i.id]=this.gameTime;for(var n=["factionId","speciesId","systemBodyId","systemId","speciesId","colonyId"],s=["id","type"],o=[],c=Object.keys(t),l=0;l<c.length;l++){var u=c[l];if(u.endsWith("Id")){if(n.includes(u)){var h=t[u],d=this.entities[h];if(d){var p=e+"Ids";d[p]||(d[p]=[]),d[p].push(i.id),this.entitiesLastUpdated[d.id]=this.gameTime}}}else u.endsWith("Ids")||i[u]&&!s.includes(u)&&(0,r.isObject)(i[u])&&(i[u].lastUpdateTime=this.gameTime,o.push(u))}return i.facets=o,i}},{key:"_addFactionEntity",value:function(e,t,i){return this.factionEntitiesLastUpdated[e][t]=this.gameTime,this.factionEntities[e][t]=(0,a.Z)({intel:{},id:t},i)}},{key:"_removeEntity",value:function(e){var t=this,i="object"===typeof e?e.id:e;this.entities[i]&&(this.entityIds.splice(this.entityIds.indexOf(i),1),Object.keys(this.factions).forEach((function(e){t.factionEntities[e][i]&&delete t.factionEntities[e][i]})),delete this.entities[i])}},{key:"_getClientsForFaction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return Object.values(this.clients).reduce((function(i,n){return n.factions[e]&&(t&&!t.includes(n.factions[e])||i.push(n.id)),i}),[])}}]),e}());function C(e,t){var i=null;return e.facets.forEach((function(n){var s=e[n];s&&s.lastUpdateTime>t&&((i=i||{})[n]=s)})),i}var T=function(){function e(){var t=this;(0,n.Z)(this,e),this.onmessage=function(e){var i=e.data,n=i.type,s=i.data,a=i.clientId,r=i.messageId;(t.server.onMessage(n,s,a)||Promise.resolve()).then((function(e){t.sendMessageToClient(1,"reply",e,r)}))},this.server=new w(this)}return(0,s.Z)(e,[{key:"broadcastToClients",value:function(e,t){i.g.postMessage({type:e,data:t})}},{key:"sendMessageToClient",value:function(e,t,n){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(1===!e)throw new Error("Invalid connectionId");var a=P(n);a instanceof ArrayBuffer?i.g.postMessage({type:t,data:a,messageId:s},[a]):i.g.postMessage({type:t,data:a,messageId:s})}}]),e}(),E=new TextEncoder;function P(e){return!e||!0===e||!1===e||e instanceof ArrayBuffer?e:E.encode(JSON.stringify(e)).buffer}var M=new T;i.g.onmessage=M.onmessage}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(a.exports,a,a.exports,i),a.loaded=!0,a.exports}i.m=e,i.x=function(){var e=i.O(void 0,[878],(function(){return i(8024)}));return e=i.O(e)},function(){var e=[];i.O=function(t,n,s,a){if(!n){var r=1/0;for(u=0;u<e.length;u++){n=e[u][0],s=e[u][1],a=e[u][2];for(var o=!0,c=0;c<n.length;c++)(!1&a||r>=a)&&Object.keys(i.O).every((function(e){return i.O[e](n[c])}))?n.splice(c--,1):(o=!1,a<r&&(r=a));if(o){e.splice(u--,1);var l=s();void 0!==l&&(t=l)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[n,s,a]}}(),i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce((function(t,n){return i.f[n](e,t),t}),[]))},i.u=function(e){return"static/js/"+e+".51137940.chunk.js"},i.miniCssF=function(e){},i.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e},i.p="./",function(){var e={24:1};i.f.i=function(t,n){e[t]||importScripts(i.p+i.u(t))};var t=self.webpackChunkreact4xgame2=self.webpackChunkreact4xgame2||[],n=t.push.bind(t);t.push=function(t){var s=t[0],a=t[1],r=t[2];for(var o in a)i.o(a,o)&&(i.m[o]=a[o]);for(r&&r(i);s.length;)e[s.pop()]=1;n(t)}}(),function(){var e=i.x;i.x=function(){return i.e(878).then(e)}}();i.x()}();
//# sourceMappingURL=24.0d6b0912.chunk.js.map